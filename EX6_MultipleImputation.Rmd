---
title: "Example 6 Multiple Imputation& Missing Data"
author: "coreysparks"
date: "March 2, 2015"
output: html_document
---

This example will illustrate typical aspects of dealing with missing data. Topics will include: Mean imputation, modal imputation for categorical data, and multiple imputation of complex patterns of missing data. For this example I am using 2011 CDC Behavioral Risk Factor Surveillance System (BRFSS) SMART county data. [Link](http://www.cdc.gov/brfss/smart/smart_2011.htm).

```{r}
library(car)
library(survey)
library(mice) #Library for multiple imputation
library(MASS)

#load brfss
load("~/Google Drive/dem7283/data/brfss_11.Rdata")
nams<-names(brfss_11)
newnames<-gsub("_", "", nams)
names(brfss_11)<-tolower(newnames)


#just for brevity, I just select TX respondents with non missing weights
brfss_11<-brfss_11[brfss_11$state==48&is.na(brfss_11$cntywt)==F,]

#insurance
brfss_11$ins<-recode(brfss_11$hlthpln1, recodes="1=1;2=0;else=NA")
#smoking currently
brfss_11$smoke<-recode(brfss_11$smoker3, recodes="1:2=1; 3:4=0; else=NA")
#low physical activity
brfss_11$lowact<-recode(brfss_11$pacat, recodes="1:2=0; 3:4=1; else=NA")
#high blood pressure
brfss_11$hbp<-recode(brfss_11$bphigh4, recodes="1=1; 2:4=0; else=NA")
#high cholesterol
brfss_11$hc<-recode(brfss_11$toldhi2, recodes="1=1; 2=0; else=NA")
#bmi
brfss_11$bmi<-ifelse(is.na(brfss_11$bmi5)==T, NA, brfss_11$bmi5/100)
#poor or fair health
brfss_11$badhealth<-recode(brfss_11$genhlth, recodes="4:5=1; 1:3=0; else=NA")

#race
brfss_11$black<-recode(brfss_11$racegr2, recodes="2=1; 9=NA; else=0", as.factor.result=T)
brfss_11$white<-recode(brfss_11$racegr2, recodes="1=1; 9=NA; else=0", as.factor.result=T)
brfss_11$other<-recode(brfss_11$racegr2, recodes="3:4=1; 9=NA; else=0", as.factor.result=T)
brfss_11$hispanic<-recode(brfss_11$racegr2, recodes="5=1; 9=NA; else=0", as.factor.result=T)

#have a personal doctor?
brfss_11$doc<-recode(brfss_11$persdoc2, recodes="1:2=1; 3=0; else=NA", as.factor.result=F)

#needed care in last year but couldn't get it because of cost
brfss_11$medacc<-recode(brfss_11$medcost, recodes="1=1;2=0;else=NA")

#education level
brfss_11$educ<-recode(brfss_11$educa, recodes="1:2='0Prim'; 3='1somehs'; 4='2hsgrad'; 5='3somecol'; 6='4colgrad';9=NA", as.factor.result=T)
brfss_11$educ<-relevel(brfss_11$educ, ref='2hsgrad')

#employment
brfss_11$emp<-recode(brfss_11$employ, recodes="1:2='Employed'; 2:6='nilf'; 7='retired'; 8='unable'; else=NA", as.factor.result=T)
brfss_11$emp<-relevel(brfss_11$emp, ref='Employed')

#marital status
brfss_11$marst<-recode(brfss_11$marital, recodes="1='married'; 2='divorced'; 3='widowed'; 4='separated'; 5='nm';6='cohab'; else=NA", as.factor.result=T)
brfss_11$marst<-relevel(brfss_11$marst, ref='married')

#income
brfss_11$inc<-recode(brfss_11$incomg, recodes="1='<15k'; 2='15 to 25k'; 3='25 to 35k'; 4='35 to 50k'; 5='50k+';9=NA", as.factor.result = T)

#Age cut into intervals
brfss_11$agec<-cut(brfss_11$age, breaks=c(0,24,39,59,79,99))

```

Now, we can get a general idea of the missingness of these variables by just using `summary(brfss_11)`

```{r}
summary(brfss_11[, c("ins", "smoke", "lowact", "hbp", "hc", "bmi", "badhealth", "black", "doc", "educ", "emp", "marst", "inc")])
```

Which shows that, among these recoded variables, `hc` or the indicator for high cholesterol is missing the most with 1117 people in our TX sample missing, or `r 100* (table(is.na(brfss_11$hc))[2]/length(brfss_11$hc))`% of the sample. The lowest number of missings is in the education variable, which only has `r 100* (table(is.na(brfss_11$educ))[2]/length(brfss_11$educ))`% missing.

###Mean imputation
Now, i'm going to illustrate mean imputation of a continuous variable, BMI.
```{r}
#I'm going to play with 3 outcomes, bmi, having a regular doctor and income category
summary(brfss_11$bmi) #467 missing, 6%

#what happens when we replace the missings with the mean?
brfss_11$bmi.imp.mean<-ifelse(is.na(brfss_11$bmi)==T, mean(brfss_11$bmi, na.rm=T), brfss_11$bmi)

mean(brfss_11$bmi, na.rm=T)
mean(brfss_11$bmi.imp.mean) #no difference!

median(brfss_11$bmi, na.rm=T)
median(brfss_11$bmi.imp.mean) #slight difference

var(brfss_11$bmi, na.rm=T)
var(brfss_11$bmi.imp.mean) # more noticeable difference!

```

So what we see here, is that imputing with the mean does nothing to central tendency (when measured using the mean, but does affect the median), but it does reduce the variance in the outcome. This is because you're replacing all missing cases with the most likely value (the mean), so you're artificially deflating the variance. That's not good.

We can see this in a histogram:
```{r}
#plot the histogram
hist(brfss_11$bmi.imp.mean)
hist(brfss_11$bmi, add=T ,col=1) #you can see the extra values at the mean

```

###Modal imputation
If we have a categorical variable, an easy way to impute the values is to use modal imputation, or impute cases with the mode, or most common value. It doesn't make sense to use the mean, because what would that mean for a categorical variable?

```{r}
table(brfss_11$emp)
#find the most common value
mcv.emp<-factor(names(which.max(table(brfss_11$emp))), levels=levels(brfss_11$emp))
mcv.emp
#impute the cases
brfss_11$emp.imp<-as.factor(ifelse(is.na(brfss_11$emp)==T, mcv.emp, brfss_11$emp))
levels(brfss_11$emp.imp)<-levels(brfss_11$emp)

prop.table(table(brfss_11$emp))
prop.table(table(brfss_11$emp.imp))

barplot(prop.table(table(brfss_11$emp)), main="Original Data", ylim=c(0, .6))
barplot(prop.table(table(brfss_11$emp.imp)), main="Imputed Data",ylim=c(0, .6))
```

Which doesn't look like much of a difference because only 55 people were missing. Now let's try modal imputation on income group:

```{r}
table(brfss_11$inc)
#find the most common value
mcv.inc<-factor(names(which.max(table(brfss_11$inc))), levels=levels(brfss_11$inc))
mcv.inc
#impute the cases
brfss_11$inc.imp<-as.factor(ifelse(is.na(brfss_11$inc)==T, mcv.inc, brfss_11$inc))
levels(brfss_11$inc.imp)<-levels(brfss_11$inc)

prop.table(table(brfss_11$inc))
prop.table(table(brfss_11$inc.imp))

barplot(prop.table(table(brfss_11$inc)), main="Original Data", ylim=c(0, .6))
barplot(prop.table(table(brfss_11$inc.imp)), main="Imputed Data", ylim=c(0, .6))
```

Which shows how dramatically we alter the distribution of the variable by imputing at the mode.

###Multiple Imputation
These days, these types of imputation have been far surpassed by more complete methods that are based upon regression methods. These methods are generally referred to as multiple imputation, because we are really interested in imputing multiple variables simultaneously. Instead of reviewing this perspective here, I suggest you have a look at Joe Schafer's [site](http://sites.stat.psu.edu/~jls/mifaq.html) that gives a nice treatment of the subject. Here, I will use the imputation techniques in the `mice` library in R, which you can read about [here](http://www.jstatsoft.org/v45/i03/paper).

I have used these in practice in publications and generally like the framework the library uses. Another popular technique is in the `Amelia` library of [Gary King](http://gking.harvard.edu/amelia), which I haven't used much. If you are serious about doing multiple imputation it would be advised to investigate multiple methodologies.

To begin, I explore the various patterns of missingness in the data. The `md.pattern` function in `mice` does this nicely. Here, each row corresponds to a particular pattern of missingness (1 = observed, 0=missing)
```{r}
#look at the patterns of missingness
md.pattern(brfss_11[,c("bmi", "inc", "agec","educ","black","white","hispanic")])
```

Shows that 6,116 rows of the data are complete (first row). The second row shows that 288 people are missing *only* the bmi variable. I say *only* because `r table(is.na(brfss_11$bmi))[2]` people are missing the bmi variable in total. Apparently some folks are missing in combination with other variables. Sure enough, if we look down, we see that 3 people are missing bmi *AND* educ, 152 are missing bmi *AND* inc, and so on. The bottom row tells how many total people are missing each variable, in *ANY* combination with other variables.

If you want to see how pairs of variables are missing together, the `md.pairs()` function will show this. A pair of variables can have exactly four missingness patterns: both variables are observed (pattern `rr`), the first variable is observed and the second variable is missing (pattern `rm`), the first variable is missing and the second variable is observed (pattern `mr`), and both are missing (pattern `mm`).
```{r}
md.pairs(brfss_11[,c("bmi", "inc", "agec","educ","black","white","hispanic")])
```

###Basic imputation:
We can perform a basic multiple imputation by simply doing: **Note this may take a long time with big data sets**
```{r}
imp<-mice(data = brfss_11[,c("bmi", "inc", "agec","educ","black","white","hispanic")], seed = 22)

print(imp)
```

Shows how many imputations were done. It also shows total missingness, which imputation method was used for each variable (because you wouldn't want to use a normal distribution for a categorical variable!!). It also shows the sequence of how each variable is visited (or imputed, the default is left to right). 

We may want to make sure imputed values are plausible by having a look:

```{r}
head(imp$imp$bmi)
head(imp$imp$inc)
```

We can also do some plotting. For instance if we want to see how the observed and imputed values of bmi look with respect to income, we can do:
```{r, fig.height=7, fig.width=8}
stripplot(imp,bmi~inc|.imp, pch=20)
```

and we see the distribution of the original data (blue dots), the imputed data (red dots) across the levels of income, for each of the five different imputation runs(the number at the top shows which run, and the first plot is the original data).

This plot shows that the bmi values correspond well with the observed data, so they are probably plausible values.

If we want to get our new, imputed data, we can use the `complete()` function, which by default extracts the first imputed data set. If we want a different one, we can do `complete(imp, action=3)` for example, to get the third imputed data set.
```{r}
dat.imp<-complete(imp)
head(dat.imp, n=10)

#Compare to the original data
head(brfss_11[,c("bmi", "inc", "agec","educ","black","white","hispanic")], n=10)
```

While the first few cases don't show much missingness, we can coax some more interesting cases out and compare the original data to the imputed:

```{r}
head(dat.imp[is.na(brfss_11$bmi)==T,], n=10)
head(brfss_11[is.na(brfss_11$bmi)==T,c("bmi", "inc", "agec","educ","black","white","hispanic")], n=10)

```

###Analyzing the imputed data
A key element of using imputed data, is that the relationships we want to know about should be maintained after imputation, and presumably, the relationships within each imputed data set will be the same. So if we used each of the (5 in this case) imputed data sets in a model, then we should see similar results across the five different models.

Here I look at a linear model for bmi:
```{r}
#Now, I will see the variability in the 5 different imputations for each outcom
fit.bmi<-with(data=imp ,exp=lm(bmi~inc+agec+educ+black+hispanic))
fit.bmi
```

Which we can compare to the model fit on the original data, with missings eliminated:
```{r}
summary(lm(bmi~inc+agec+educ+black+hispanic, data=brfss_11))
```

And we see the same relationships, and the same significant effects.

Now we pool the separate models:
```{r}
est.p<-pool(fit.bmi)
print(est.p)
summary(est.p)

#compare to original data
summary(lm(bmi~inc+agec+educ+black+hispanic, data=brfss_11))
```

If we wanted to see the ranges of the betas in the five imputed data models, we could do that:
```{r, fig.height=6, fig.width=9}
#get the coefficients from each of the 5 imputations of bmi
coefs<-matrix(unlist(lapply(fit.bmi$analyses, coef)), nrow=5, ncol=15, byrow=T)

#plot the coefficients from each of the different rounds of imputation to see the variability in the
#results
plot(coefs[1,-1], ylim=c(-2, 4), xaxt="n",cex=1.5, pch=20, ylab="beta")
axis(1, at=1:14, labels=names(fit.bmi$analyses[[1]]$coef[-1]))
cols=2:5
for(i in 1:dim(coefs)[1]-1){
  points(coefs[i+1,-1], col=cols[i], cex=1.5, pch=20)
}
title(main="Estimated Betas from Each Imputed Regression Model for BMI Outcome")

```

###Customized imputations

Now, what if I don't want to use all information within the data to impute the values, let's say I only want to use age to predict BMI, and not race. I can customize which variables are used in the imputation process by generating a predictor matrix:

```{r, fig.height=6, fig.width=9}
#I have to provide a matrix of which variables will be used for imputing the other variables,
#I basically don't want the bmi, doc or inc variables to be influenced by the key predictors I want to use
#to analyze them later. So I only use income and age to predict BMI
predictorMatrix<-matrix(
c(
0,1,1,0,0,0,0,
0,0,1,1,0,0,0,
1,1,0,0,0,0,0,
0,1,1,0,1,1,1,
0,1,1,1,0,1,1,
0,1,1,1,1,0,1,
0,1,1,1,1,1,0), nrow=7, ncol=7, byrow=T)

colnames(predictorMatrix)<-rownames(predictorMatrix)<-c("bmi", "inc", "agec","educ","black","white","hispanic")
predictorMatrix
newimp<-mice(data = brfss_11[,c("bmi","inc", "agec","educ","black","white","hispanic")], seed = 22, predictorMatrix = predictorMatrix)

print(newimp)
fit.bmi2<-with(data=newimp ,exp=lm(bmi~inc+agec+educ+black+hispanic))
est.p2<-pool(fit.bmi)
summary(est.p2)

#get the coefficients from each of the 5 imputations of bmi
coefs2<-matrix(unlist(lapply(fit.bmi2$analyses, coef)), nrow=5, ncol=15, byrow=T)

#plot the coefficients from each of the different rounds of imputation to see the variability in the
#results
plot(coefs2[1,-1], ylim=c(-2, 4), xaxt="n",cex=1.5, pch=20, ylab="beta")
axis(1, at=1:14, labels=names(fit.bmi2$analyses[[1]]$coef[-1]))
cols=2:5
for(i in 1:dim(coefs2)[1]-1){
  points(coefs2[i+1,-1], col=cols[i], cex=1.5, pch=20)
}
title(main="Estimated Betas from Each Imputed Regression Model for BMI Outcome")
```



