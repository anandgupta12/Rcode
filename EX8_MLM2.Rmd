---
title: "Multi-level Models 2"
author: "coreysparks"
date: "March 30, 2015"
header-includes:
   - \usepackage{bbm}
output: html_document
---

In this example, I introduce how to fit the multi-level model using the `lme4` [package](http://cran.r-project.org/web/packages/lme4/index.html). This example continues from the first example and considers the linear case of the model with random slopes and the use of a higher-level predictor. The example is extended to a binary outcome to illustrate the logistic Generalized Linear Mixed Model (GLMM). 

This example shows how to:
* Examine variation between groups using fixed effects
* Fit the basic random intercept model : 
  +$y_{ij} = \mu + u_{j} + e_{ij}$ with $u_j \sim N(0, \sigma^2)$
Where the intercepts ($u_j$) for each group vary randomly around the overall mean ($\mu$)

*I also illustrate how to include group-level covariates and how to fit the random slopes model and the model for cross level interactions


The example merges data from the 2011 CDC Behavioral Risk Factor Surveillance System (BRFSS) SMART county data. [Link](http://www.cdc.gov/brfss/smart/smart_2011.htm) and the 2010 American Community Survey 5-year estimates at the county level. More details on these data are found below.

```{r load data&recode , message=FALSE}
library(lme4)
library(arm)
library(lmerTest)
library(car)
library(MASS)
library(ggplot2)
library(sjPlot)

#load brfss
load("~/Google Drive/dem7283/data/brfss_11.Rdata")
nams<-names(brfss_11)
newnames<-gsub("_", "", nams)
names(brfss_11)<-tolower(newnames)

brfss_11$statefip<-sprintf("%02d", brfss_11$state )
brfss_11$cofip<-sprintf("%03d", brfss_11$cnty )
brfss_11$cofips<-paste(brfss_11$statefip, brfss_11$cofip, sep="")

#just for brevity, I just select TX respondents with non missing weights
brfss_11<-brfss_11[is.na(brfss_11$cntywt)==F,]
#insurance
brfss_11$ins<-ifelse(brfss_11$hlthpln1==1,1,0)
#smoking currently
brfss_11$smoke<-recode(brfss_11$smoker3, recodes="1:2=1; 3:4=0; else=NA")
#low physical activity
brfss_11$lowact<-recode(brfss_11$pacat, recodes="1:2=0; 3:4=1; else=NA")
#high blood pressure
brfss_11$hbp<-recode(brfss_11$bphigh4, recodes="1=1; 2:4=0; else=NA")
#high cholesterol
brfss_11$hc<-recode(brfss_11$toldhi2, recodes="1=1; 2=0; else=NA")
#bmi
brfss_11$bmi<-ifelse(is.na(brfss_11$bmi5)==T, NA, brfss_11$bmi5/100)
#poor or fair health
brfss_11$badhealth<-ifelse(brfss_11$genhlth %in% c(4,5),1,0)

#race
brfss_11$black<-recode(brfss_11$racegr2, recodes="2=1; 9=NA; else=0", as.factor.result=T)
brfss_11$white<-recode(brfss_11$racegr2, recodes="1=1; 9=NA; else=0", as.factor.result=T)
brfss_11$other<-recode(brfss_11$racegr2, recodes="3:4=1; 9=NA; else=0", as.factor.result=T)
brfss_11$hispanic<-recode(brfss_11$racegr2, recodes="5=1; 9=NA; else=0", as.factor.result=T)

#have a personal doctor?
brfss_11$doc<-recode(brfss_11$persdoc2, recodes="1:2=1; 3=0; else=NA", as.factor.result=F)

#needed care in last year but couldn't get it because of cost
brfss_11$medacc<-recode(brfss_11$medcost, recodes="1=1;2=0;else=NA")

#education level
brfss_11$lths<-recode(brfss_11$educa, recodes="1:3=1;9=NA; else=0", as.factor.result=F)
brfss_11$coll<-recode(brfss_11$educa, recodes="5:6=1;9=NA; else=0", as.factor.result=F)

#employment
brfss_11$employ<-recode(brfss_11$employ, recodes="1:2='Employed'; 2:6='nilf'; 7='retired'; 8='unable'; else=NA", as.factor.result=T)
brfss_11$employ<-relevel(brfss_11$employ, ref='Employed')

#marital status
brfss_11$marst<-recode(brfss_11$marital, recodes="1='married'; 2='divorced'; 3='widowed'; 4='separated'; 5='nm';6='cohab'; else=NA", as.factor.result=T)
brfss_11$marst<-relevel(brfss_11$marst, ref='married')

#income
brfss_11$inc<-as.factor(ifelse(brfss_11$incomg==9, NA, brfss_11$incomg))

#Age cut into intervals
brfss_11$agec<-cut(brfss_11$age, breaks=c(0,24,39,59,79,99))

```


###Higher level predictors
We will often be interested in factors at both the individual *AND* contextual levels. To illustrate this, I will use data from the American Community Survey measured at the county level. Specifically, I use the DP3 table, which provides economic characteristics of places, from the 2010 5 year ACS [Link](http://www.census.gov/acs/www/data_documentation/special_data_release/).

```{r load_acs}
#I will also add in some Census variables from the ACS 2010 5 Year estimates
#load in ACS data from Factfinder
acsecon<-read.csv("~/Google Drive/dem7283/data/aff_download/ACS_10_5YR_DP03_with_ann.csv")
acsecon$povrate<-acsecon[, "HC03_VC156"]
acsecon$unemployed<-acsecon[, "HC03_VC13"]
acsecon$cofips<-substr(acsecon$GEO.id, 10,14)
acsecon$povz<-scale(acsecon$povrate, center=T, scale=T)
acsecon$unempz<-scale(acsecon$unemployed, center=T, scale=T)
acsecon<-acsecon[, c("cofips", "povrate","povz", "unemployed","unempz")]

head(acsecon)

joindata<-merge(brfss_11, acsecon, by="cofips", all.x=T, all.y=F)
#and merge the data back to the kids data
joindata$bmiz<-scale(joindata$bmi, center=T, scale=T)
joindata$agez<-scale(joindata$age, center=T, scale=T)

```

###Fitting the basic multi-level model - Random intercepts

* The random intercept model assumes you have:
  + *j groups (j=1 to J)*
  + *i individuals within the j groups (i=1 to $n_j$)*
  + for each individual in the *j* groups you have measured $y_{ij}$ and $x_{ij}$ 
and *potentially* for each group *j*, we have may have measured $z_j$ which is a covariate measured at the group level
For example, you do a survey on health and you measure:
+ y = the health status of each individual
+ x= SES, race, etc of each individual
+ j = the county each individual lives in, and
+ z = the poverty rate or median income in the county


To specify a random intercept model for counties, we add, a model term that is (1|HIGHER LEVEL VARIABLE), which tells R to fit only a random intercept for each county, in our case it will be `(1|cofips)`

```{r}
fit.mix<-lmer(bmiz~agez+lths+coll+black+hispanic+other+(1|cofips), data=joindata)
#do a test for the random effect
rand(fit.mix)
display(fit.mix, detail=T)

```



###Multilevel model with group-level predictor
Now, I fit the same model above, but this time I include a predictor at the county level, the poverty rate.

```{r}
#Now I estimate the multilevel model including the effects for the
#county level variables
fit.mix2<-lmer(bmiz~agez+lths+coll+black+hispanic+other+povz+(1|cofips), data=joindata)
display(fit.mix2, detail=T)
rand(fit.mix2)
ICC2<-VarCorr(fit.mix2)$cofips[1]/( VarCorr(fit.mix2)$cofips[1]+attr(VarCorr(fit.mix2), "sc"))
ICC2

#compare the random intercept ad multilevel model with a LRT
anova(fit.mix, fit.mix2)
#There is slight improvement, p=.0572 becuase the poverty variable was almost significant, t=1.90

```

The ICC goes down, which points to the fact that we are controlling away some of the between-county variance by including the county level predictor. The improvement in model fit is __almost__ "significant" at the 5% level. 



###Random slope models

* We expand the random effect model to include group-varying slopes by:
$$
\begin{aligned}
\ E( Y) = \beta_{0j}+ \beta_{ j} x\\
\beta_{0j} = \beta_0 + u_{1j}\\
\beta_{j} = \beta + u_{2j}\\
\end{aligned}\\
\text{Where } \beta_0  \text{ is the average intercept, and } u_{1j } \text{ is }\\
\text{the group-specific deviation in the intercept}\\
\text{And where } \beta \text{ is the average slope, and } u_{2j } \text{ is}\\
\text{the group-specific deviation in the average slope}\\
$$

This effectively allows one or more of the individual level variables to have different effects in each of the groups. 

```{r}
#To do a random slope model, I do:
fit.mix3<-lmer(bmiz~agez+lths+coll+black+hispanic+other+(black|cofips), joindata)
display(fit.mix3, digits=3)
rand(fit.mix3,)

#compare the first model to the one with a random slope with a likelihood ratio test
anova(fit.mix, fit.mix3)
#the random slope model fits better

#plot random slopes and intercepts
rancoefs2<-ranef(fit.mix3)

plot(NULL, ylim=c(-.5, .5), xlim=c(-1,1),ylab="Intercept", xlab="Age")
title (main="Random Slope and Intercept Model")

for (i in 1: dim(rancoefs2$cofips)[1]){
  
  abline(a=fixef(fit.mix3)[1]+rancoefs2$cofips[[1]][i], b=fixef(fit.mix3)[2]+rancoefs2$cofips[[2]][i], col=2)
}
```

So, here we see a significant variance among counties in the effects of the 'black' variable. in addition to the output from `rand()`, the `anova()` also shows the model improves overall compared to the model with only a random intercept. 

###Cross level interaction effect
Here, I show the model for a cross-level interaction. This model fits an interaction term between (at least) one individual level variable and a group level variable. This allows you to ask very informative questions regarding individuals within specific contexts. As a good rule, *always* z-score your higher level predictors **BEFORE MERGINGE TO THE INDIVIDUAL DATA** in order to ease interpretation of these effects.  In this example, I as the reserach question, "Do Racial/ethnic minority groups, livinging in high poverty areas face an added disadvantage in BMI, compared to whites?"

```{r}
#Cross-level interaction model:
fit.mix4<-lmer(bmiz~agez+lths+coll+black+hispanic+other+black*povz+hispanic*povz+other*povz+(1|cofips), joindata)
display(fit.mix4,detail=T, digits=3)
rand(fit.mix4)
anova(fit.mix, fit.mix4)

```

This basically says that racial/ethnic minorities in counties with higher than average poverty rates (povz==1 vs povz==0) have higher BMI's than whites 


### Logistic Generalized Linear Mixed Model (GLMM)
Just like when we did ordinary logistic regression, vs. least squares, we use a slightly different function `glm()` vs. `lm()`. Same goes here, we will use `glmer()` vs `lmer()`. This example will fit a multilevel logistic regression model.

**NOTE** GLMM's can take much longer to estimate than LMM's, don't be surprised if your model takes a long time to run. Also don't be surprised if you see warning messages like 
```Warning message:```
```In checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :```
```  Model failed to converge with max|grad| = somenumber (tol = 0.001)```

```{r, message=FALSE, warning=FALSE}
#Just for quickness, i subset to TX & CA only
joindatatx<-joindata[joindata$state%in%c(6,48),]
#Here I fit a binomial model for healthcare access
fit.mix.bin<-glmer(doc~agez+lths+coll+black+hispanic+other+(1|cofips), family=binomial, joindatatx)
display(fit.mix.bin, detail=T)

#odds ratios
exp(fixef(fit.mix.bin)[-1])
sjp.glmer(fit.mix.bin, facet.grid = FALSE,type="ri.pc")
```

So, we see that older people are more likely to have a regular doctor, as are those with a college education. On the other hand, those with low levels of education, and all of the racial/ethnic minorities are less likely to have a regular doctor. Unfortunately, there is no *easy way* test for random effects in GLMM's in R.

### Random slopes GLMM
```{r, message=FALSE, warning=FALSE}
fit.mix.bin2<-glmer(doc~agez+lths+coll+black+hispanic+other+(black+hispanic+other+1|cofips), family=binomial, joindatatx)
display(fit.mix.bin2, detail=T)
exp(fixef(fit.mix.bin2))


sjp.glmer(fit.mix.bin2, facet.grid = FALSE,type="ri.pc")
```

So, we see that there are pretty sizeable variances in all of the three race/ethnicity variables, suggesting that across the counties in the data, there is heterogeneity in the means of the BMI for these groups. i.e. it's not always the case that minority groups face a disadvantage in terms of BMI in all counties in these two states.

### Cross-level GLMM
We can likewise examine a cross-level interaction model like we did above:

```{r, message=FALSE, warning=FALSE}
fit.mix.bin3<-glmer(doc~agez+lths+coll+(black+hispanic+other)*povz+(1|cofips), family=binomial, joindatatx)
display(fit.mix.bin3, detail=T)
exp(fixef(fit.mix.bin3))
```

So, we see that, in these two states at least, blacks and hispanics don't face an added disparity against having a regular doctor, but other race/ethnicities do (at least this interaction term is marginally significant in the model)
