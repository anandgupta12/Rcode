---
title: "Principal Components Analysis"
author: "coreysparks"
date: "March 16, 2015"
output: html_document
---

This example illustrates the use of the method of Principal Components to form an index of overall health using data from the 2011 CDC Behavioral Risk Factor Surveillance System (BRFSS) SMART county data. [Link](http://www.cdc.gov/brfss/smart/smart_2011.htm). 

Principal Components is a mathematical technique (not a statistical one!) based off the eigenvalue decomposition/singular value decomposition of a data matrix (or correlation/covariance matrix) [Link](http://en.wikipedia.org/wiki/Singular_value_decomposition). This technique re-represents a complicated data set (set of variables) in a simpler form, where the information in the original variables is now represented by fewer *components*, which represent the majority (we hope!!) of the variance in the original data. This is known as a variable reduction strategy.  It is also used commonly to form indices in the behavioral/social sciences. It is closely related to factor analysis [Link](http://en.wikipedia.org/wiki/Factor_analysis), and indeed the initial solution of factor analysis is often the exact same as the PCA solution. PCA preserves the orthogonal nature of the components, while factor analysis can violate this assumption. 


```{r}
library(car)
library(foreign)
library(survey)
library(ggplot2)
#load brfss
load("~/Google Drive/dem7283/data/brfss_11.Rdata")
nams<-names(brfss_11)
newnames<-gsub("_", "", nams)
names(brfss_11)<-tolower(newnames)

brfss_11$statefip<-sprintf("%02d", brfss_11$state )
brfss_11$cofip<-sprintf("%03d", brfss_11$cnty )
brfss_11$cofips<-paste(brfss_11$statefip, brfss_11$cofip, sep="")

brfss_11$healthydays<-ifelse(brfss_11$physhlth %in%c(77,99), NA,ifelse(brfss_11$physhlth==88,0, brfss_11$physhlth))
brfss_11$healthymdays<-ifelse(brfss_11$menthlth %in%c(77,99), NA,ifelse(brfss_11$menthlth==88,0, brfss_11$menthlth))
#insurance
brfss_11$ins<-ifelse(brfss_11$hlthpln1==1,1,0)
#smoking currently
brfss_11$smoke<-recode(brfss_11$smoker3, recodes="1:2=1; 3:4=0; else=NA")
#low physical activity
brfss_11$lowact<-recode(brfss_11$pacat, recodes="1:2=0; 3:4=1; else=NA")
#high blood pressure
brfss_11$hbp<-recode(brfss_11$bphigh4, recodes="1=1; 2:4=0; else=NA")
#high cholesterol
brfss_11$hc<-recode(brfss_11$toldhi2, recodes="1=1; 2=0; else=NA")
#bmi
brfss_11$bmi<-ifelse(is.na(brfss_11$bmi5)==T, NA, brfss_11$bmi5/100)
#poor or fair health
brfss_11$badhealth<-ifelse(brfss_11$genhlth %in% c(4,5),1,0)

#race
brfss_11$black<-recode(brfss_11$racegr2, recodes="2=1; 9=NA; else=0")
brfss_11$white<-recode(brfss_11$racegr2, recodes="1=1; 9=NA; else=0")
brfss_11$other<-recode(brfss_11$racegr2, recodes="3:4=1; 9=NA; else=0")
brfss_11$hispanic<-recode(brfss_11$racegr2, recodes="5=1; 9=NA; else=0")

#have a personal doctor?
brfss_11$doc<-recode(brfss_11$persdoc2, recodes="1:2=1; 3=0; else=NA")

#needed care in last year but couldn't get it because of cost
brfss_11$medacc<-recode(brfss_11$medcost, recodes="1=1;2=0;else=NA")

#education level
brfss_11$educ<-recode(brfss_11$educa, recodes="1:2='0Prim'; 3='1somehs'; 4='2hsgrad'; 5='3somecol'; 6='4colgrad';9=NA", as.factor.result=T)
brfss_11$educ<-relevel(brfss_11$educ, ref='2hsgrad')

#employment
brfss_11$employ2<-recode(brfss_11$employ , recodes="1:2='Employed'; 2:6='nilf'; 7='retired'; 8='unable'; else=NA", as.factor.result=T)
brfss_11$employ2<-relevel(brfss_11$employ2, ref='Employed')

#marital status
brfss_11$marst<-recode(brfss_11$marital, recodes="1='married'; 2='divorced'; 3='widowed'; 4='separated'; 5='nm';6='cohab'; else=NA", as.factor.result=T)
brfss_11$marst<-relevel(brfss_11$marst, ref='married')

#income
brfss_11$inc<-ifelse(brfss_11$incomg==9, NA, brfss_11$incomg)

#Age cut into intervals
brfss_11$agec<-cut(brfss_11$age, breaks=c(0,24,39,59,79,99))

```


###Analysis
Now we prepare to fit the survey corrected model. Here I just get the names of the variables that i will use, this keeps the size of things down, in terms of memory used

```{r}
vars<-names(brfss_11)[c(6, 94, 189:214)]
brfss_11.sub<-subset(brfss_11[,vars], complete.cases(brfss_11[,vars]))

```

We use the prcomp function to do the pca, we specify our variables we want in our index using a formula, the name of the data, we also specify R to z-score the data (center=T removes the mean, scale=T divides by the standard deviation for each variable), and the retx=T will calculate the PC scores for each individual for each component.

```{r}
brfss.pc<-prcomp(~healthydays+healthymdays+ins+smoke+lowact+hbp+hc+bmi+badhealth,data=brfss_11.sub, center=T, scale=T, retx=T)

#Screeplot
screeplot(brfss.pc, type = "l")
abline(h=1)

#Request some basic summaries of the PCA analysis option(digits=3)
summary(brfss.pc)
brfss.pc$rotation
#then I plot the first 2 components
hist(brfss.pc$x[,1])
hist(brfss.pc$x[,2])
```

The first two components account for 38.8% of the variation in the input variables, that isn't bad. Also, we see 3 eigenvalues of at least 1, which suggests there are 3 real components among these 9 variables (remember, we are looking for eigenvalues > 1 when using z-scored data). 

In terms of the loadings for PC1, we see positive associations with everything but insurace status. We may interpret this component as an index for overall health status, since all health variables are loading in the same direction.  

For PC2 we see a mixture of loadings, some positive, some negative, and the only two variables that aren't loading heavily are low physical activity (lowact) and fair/poor self rated health (badhealth). We may interpret this components as more of a metabolic physical  health status, since the postive loadings are on the cardio-pulmonary and body mass variables (hpb, hc and bmi), with the exception of insurance coverage, while the more negative loadings are on more ot the health behaviors variables. 

Of course, interpreting components is more art than science...


Next, I calculate the correlation between the first 2 components to show they are orthogonal, i.e. correlation == 0

```{r}

cor(brfss.pc$x[,1:2])

brfss_11.sub$pc1<-brfss.pc$x[,1]
brfss_11.sub$pc2<-brfss.pc$x[,2]
```

Here we examine correlation among our health variables

```{r}
round(cor(brfss_11.sub[,c(9:17)]), 3)
```


Sometimes it's easier to look at the correlations among the original variables and the components
```{r}
round(cor(brfss_11.sub[,c(9:17, 29:30)]),3)

```


```{r}
#Make the survey design object
options(survey.lonely.psu = "adjust")
brfss_11.sub<-brfss_11.sub[complete.cases(brfss_11.sub),]
des<-svydesign(ids=~psu, strata=~ststr, weights=~cntywt, data=brfss_11.sub , nest=T)

#means of the variables in the index
svymean(~healthydays+healthymdays+ins+smoke+lowact+hbp+hc+bmi+badhealth, des, estimate.only=T )
```

The first analysis will look at variation in my health index across age, and work status:
```{r}
boxplot(pc1~agec, data=brfss_11.sub)
boxplot(pc1~educ, data=brfss_11.sub)

```

The age plot is nice, and really shows that older ages have higher values for our health index variable, which confirms our interpretation that higher values of the index are "not good"

Now we do some hypothesis testing. This model will examine variation in my health index across age, education, race and two healthcare access variables:

```{r, fig.height=7, fig.width=9}
fit.1<-svyglm(pc1~agec+educ+(black+hispanic+other)+medacc+inc, des, family=gaussian)
summary(fit.1)
vif(fit.1)


#use survey procedure to do pca
svy.pc<-svyprcomp(formula=~healthydays+healthymdays+ins+smoke+lowact+hbp+hc+bmi+badhealth, center=T, scale.=T,scores=T, des)

brfss_11.sub$pcs1<-svy.pc$x[,1]
brfss_11.sub$pcs2<-svy.pc$x[,2]

#Just look at the non-survey pc1 vs the survey pc1
ggplot(brfss_11.sub, aes(x=pc1, y=pcs1))+geom_point(alpha=.05)+theme_gray()
ggplot(brfss_11.sub, aes(x=pc1, y=pcs1)) + stat_binhex()
```

###Quick Factor analysis
In case you were wondering about how to do basic factor analysis, here you go:

```{r}

brfss.fa<-svyfactanal(~healthydays+healthymdays+ins+smoke+lowact+hbp+hc+bmi+badhealth, factors=3 , design=des, n="effective", rotation="varimax")
brfss.fa
brfss.fa$loadings

x<-scale(cbind(brfss_11.sub[,c("healthydays", "healthymdays", "ins", "smoke", "lowact", "hbp", "hc", "bmi", "badhealth")]))

brfss.fact.scores <- x%*%solve(cor(x))%*%loadings(brfss.fa)


#then I plot the first 2 factors
hist(brfss.fact.scores[,1])
hist(brfss.fact.scores[,2])

brfss_11.sub$fa1<-brfss.fact.scores[,1]
brfss_11.sub$fa2<-brfss.fact.scores[,2]

ggplot(brfss_11.sub, aes(x=pcs1, y=fa1))+geom_point(alpha=.05)+theme_gray()
ggplot(brfss_11.sub, aes(x=pcs1, y=fa1)) + stat_binhex()

cor(brfss_11.sub[c("pcs1", "fa1")])

#ggplot(brfss_11.sub, aes(x=fa1, y=fa2))+geom_point(alpha=.05)+theme_gray()
```

So we get a slightly *cleaner* health index with the first factor than with the PCA, in the FA, we see that the first factor is more of a "general health index", with the key variables being the #'s of days and the self rated health, while the second factor corresponds very well with what we saw from the PCA. Often times, factor analysis will often give cleaner looking results than PCA, because you can monkey with the initial solution.