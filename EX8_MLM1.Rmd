---
title: "Multi-level Models 1"
author: "coreysparks"
date: "March 23, 2015"
header-includes:
   - \usepackage{bbm}
output: html_document
---

In this example, I introduce how to fit the multi-level model using the `lme4` [package](http://cran.r-project.org/web/packages/lme4/index.html). This example considers the linear case of the model, where the outcome is assumed to be continuous, and the model error term is assumed to be Gaussian. Subsequent examples will highlight the Generalized Linear Mixed Model (GLMM). 

This example shows how to:
* Examine variation between groups using fixed effects
* Fit the basic random intercept model : 
  +$y_{ij} = \mu + u_{j} + e_{ij}$ with $u_j \sim N(0, \sigma^2)$
Where the intercepts ($u_j$) for each group vary randomly around the overall mean ($\mu$)

*I also illustrate how to include group-level covariates and how to fit the random slopes model and the model for cross level interactions


The example merges data from the 2011 CDC Behavioral Risk Factor Surveillance System (BRFSS) SMART county data. [Link](http://www.cdc.gov/brfss/smart/smart_2011.htm) and the 2010 American Community Survey 5-year estimates at the county level. More details on these data are found below.

```{r load data&recode}
library(lme4)
library(arm)
library(lmerTest)
library(car)
library(MASS)
library(ggplot2)

#load brfss
load("C:/Users/ozd504/Google Drive/dem7283/data/brfss_11.Rdata")
nams<-names(brfss_11)
newnames<-gsub("_", "", nams)
names(brfss_11)<-tolower(newnames)

brfss_11$statefip<-sprintf("%02d", brfss_11$state )
brfss_11$cofip<-sprintf("%03d", brfss_11$cnty )
brfss_11$cofips<-paste(brfss_11$statefip, brfss_11$cofip, sep="")

#just for brevity, I just select TX respondents with non missing weights
brfss_11<-brfss_11[is.na(brfss_11$cntywt)==F,]
#insurance
brfss_11$ins<-ifelse(brfss_11$hlthpln1==1,1,0)
#smoking currently
brfss_11$smoke<-recode(brfss_11$smoker3, recodes="1:2=1; 3:4=0; else=NA")
#low physical activity
brfss_11$lowact<-recode(brfss_11$pacat, recodes="1:2=0; 3:4=1; else=NA")
#high blood pressure
brfss_11$hbp<-recode(brfss_11$bphigh4, recodes="1=1; 2:4=0; else=NA")
#high cholesterol
brfss_11$hc<-recode(brfss_11$toldhi2, recodes="1=1; 2=0; else=NA")
#bmi
brfss_11$bmi<-ifelse(is.na(brfss_11$bmi5)==T, NA, brfss_11$bmi5/100)
#poor or fair health
brfss_11$badhealth<-ifelse(brfss_11$genhlth %in% c(4,5),1,0)

#race
brfss_11$black<-recode(brfss_11$racegr2, recodes="2=1; 9=NA; else=0", as.factor.result=T)
brfss_11$white<-recode(brfss_11$racegr2, recodes="1=1; 9=NA; else=0", as.factor.result=T)
brfss_11$other<-recode(brfss_11$racegr2, recodes="3:4=1; 9=NA; else=0", as.factor.result=T)
brfss_11$hispanic<-recode(brfss_11$racegr2, recodes="5=1; 9=NA; else=0", as.factor.result=T)

#have a personal doctor?
brfss_11$doc<-recode(brfss_11$persdoc2, recodes="1:2=1; 3=0; else=NA", as.factor.result=F)

#needed care in last year but couldn't get it because of cost
brfss_11$medacc<-recode(brfss_11$medcost, recodes="1=1;2=0;else=NA")

#education level
brfss_11$lths<-recode(brfss_11$educa, recodes="1:3=1;9=NA; else=0", as.factor.result=F)
brfss_11$coll<-recode(brfss_11$educa, recodes="5:6=1;9=NA; else=0", as.factor.result=F)

#employment
brfss_11$employ<-recode(brfss_11$employ, recodes="1:2='Employed'; 2:6='nilf'; 7='retired'; 8='unable'; else=NA", as.factor.result=T)
brfss_11$employ<-relevel(brfss_11$employ, ref='Employed')

#marital status
brfss_11$marst<-recode(brfss_11$marital, recodes="1='married'; 2='divorced'; 3='widowed'; 4='separated'; 5='nm';6='cohab'; else=NA", as.factor.result=T)
brfss_11$marst<-relevel(brfss_11$marst, ref='married')

#income
brfss_11$inc<-as.factor(ifelse(brfss_11$incomg==9, NA, brfss_11$incomg))

#Age cut into intervals
brfss_11$agec<-cut(brfss_11$age, breaks=c(0,24,39,59,79,99))


```

I want to see how many people we have in each county in the data:
```{r}

#Now we will begin fitting the multilevel regression model with the county
#that the person lives in being the higher level
table(brfss_11$cofips)
#people within each county

#How many total counties are in the data?
length(table(brfss_11$cofips))
#counties
```


###Higher level predictors
We will often be interested in factors at both the individual *AND* contextual levels. To illustrate this, I will use data from the American Community Survey measured at the county level. Specifically, I use the DP3 table, which provides economic characteristics of places, from the 2010 5 year ACS [Link](http://www.census.gov/acs/www/data_documentation/special_data_release/).

```{r load_acs}
#I will also add in some Census variables from the ACS 2010 5 Year estimates
#load in ACS data from Factfinder
acsecon<-read.csv("C:/Users/ozd504/Google Drive/dem7283/data/aff_download/ACS_10_5YR_DP03_with_ann.csv")
acsecon$povrate<-acsecon[, "HC03_VC156"]
acsecon$unemployed<-acsecon[, "HC03_VC13"]
acsecon$cofips<-substr(acsecon$GEO.id, 10,14)
acsecon$povz<-scale(acsecon$povrate, center=T, scale=T)
acsecon$unempz<-scale(acsecon$unemployed, center=T, scale=T)
acsecon<-acsecon[, c("cofips", "povrate","povz", "unemployed","unempz")]

head(acsecon)

joindata<-merge(brfss_11, acsecon, by="cofips", all.x=T, all.y=F)
#and merge the data back to the kids data
joindata$bmiz<-scale(joindata$bmi, center=T, scale=T)
joindata$agez<-scale(joindata$age, center=T, scale=T)

```

As a general rule, I will do a basic fixed-effects ANOVA as a precursor to doing full multi-level models, just to see if there is any variation amongst my higher level units (groups). If I do not see any variation in my higher level units, I generally will not proceed with the process of multi-level modeling.

```{r anova}
fit.an<-lm(bmiz~as.factor(cofips), joindata)
anova(fit.an)

```

Which shows significant variation in average BMI across counties.

As a note, if my outcome is binomial or poisson, I would do `glm(y~as.factor(cofips),family=binomial ,brfss_11)` instead of  `lm()` as this would give you the correct test for the other distributions.

###Fitting the basic multi-level model

* The random intercept model assumes you have:
  + *j groups (j=1 to J)*
  + *i individuals within the j groups (i=1 to $n_j$)*
  + for each individual in the *j* groups you have measured $y_{ij}$ and $x_{ij}$ 
and *potentially* for each group *j*, we have may have measured $z_j$ which is a covariate measured at the group level
For example, you do a survey on health and you measure:
+ y = the health status of each individual
+ x= SES, race, etc of each individual
+ j = the county each individual lives in, and
+ z = the poverty rate or median income in the county


To specify a random intercept model for counties, we add, a model term that is (1|HIGHER LEVEL VARIABLE), which tells R to fit only a random intercept for each county, in our case it will be `(1|cofips)`

```{r}
fit.mix<-lmer(bmiz~agez+lths+coll+black+hispanic+other+(1|cofips), data=joindata)
#do a test for the random effect
rand(fit.mix)
display(fit.mix, detail=T)

```

So we see that our standard deviation at the county level is .1, and the standard deviation at the individual level (residual standard deviation) is .99. Square these to get variances, of course. Our fixed effects are interpreted as normal, older people have higher BMI's than younger people, those with less than High School education have higher BMI's, while people with college education have lower BMI's than those with a high school education only. In terms of race/ethnicity, African Americans and Hispanics have higher average BMI's, compared to Non-Hispanic Whites, while those of some other race/ethnicity have lower average BMI's compared to whites. See, just like ordinary regression.

Some may be interested in getting the intra-class correlation coefficient. While I don't usually pay attention to this, here it is:
```{r ICC}
#it can be a little hairy to get it, but it can be done using various part of VarCorr()
ICC1<-VarCorr(fit.mix)$cofips[1]/( VarCorr(fit.mix)$cofips[1]+attr(VarCorr(fit.mix), "sc"))
ICC1
```

So about 1% of the variance in BMI is due to difference between counties. That's not much, but according to our random effect testing, it's not, statistically speaking, 0.

Sometimes, to gain the appreciation, we may want to plot the random effects, I first show the fixed effects, then the random effects:

```{r}
#I need to rescale the estimates to the BMI scale from the z-score scale
meanbmi<-mean(joindata$bmi, na.rm=T)
sdbmi<-sd(joindata$bmi, na.rm=T)


fixcoef<-fit.an$coefficients[1]+fit.an$coefficients[-1]
fixcoef<-(fixcoef*sdbmi)+meanbmi

plot(NULL,ylim=c(25, 30), xlim=c(0,1), ylab="Intercept", xlab="Age") # get the ylim from a summary of rancoefs1
title(main="Fixed Effect Model")

for (i in 1: length(fixcoef)[1]){
  #I plug in a beta, here it's the effect of age from fit.mix
  abline(a=fixcoef[i], b=.01,  lwd=1.5, col="green")
}


#It may be easier to visualize the random intercepts by plotting them
rancoefs1<-ranef(fit.mix)$cofips+fixef(fit.mix)[1]
rancoefs1<-(rancoefs1*sdbmi)+meanbmi
summary(rancoefs1)
plot(NULL,ylim=c(25,30), xlim=c(0,1), ylab="Intercept", xlab="Age") # get the ylim from a summary of rancoefs1
title(main="Random Intercept Models")

for (i in 1: length(rancoefs1[,1])){
  #I plug in a beta, here it's the effect of age from fit.mix
  abline(a=rancoefs1[i,1], b=.01,  lwd=1.5, col="maroon")
}

```

So what's the difference?  It may be informative to plot the estimated BMI's for each county from the OLS and multilevel models. This section illustrates the effects of "pooling" as Gelman & Hill ch 12. 

```{r}
#these models are good for estimating group means better than traditional methods
#this follows the examples in chapter 12 of Gelman and Hill, I stole the code directly from them.

#complete pooling, this model fits the grand mean ONLY
fit.cp<-lm(bmi~1, joindata)
display(fit.cp)


#No pooling i.e. fixed effects regression, this model fits separate means for each county using OLS
lm.unpooled<-lm(bmi~factor(cofips)-1, joindata)


#partial pooling, this model fits the population mean and county deviations using multilevel models
fit0<-lmer(bmi~1+(1|cofips), joindata)

#partial pooling with covariate
fit0.1<-lmer(bmi~povz+unempz+(1|cofips), joindata)


#Plot the means of the counties
J<-length(unique(joindata$cofips))
ns<-as.numeric(table(brfss_11$cofips))
sample.size <- as.numeric(table(brfss_11$cofips))
sample.size.jittered <- sample.size*exp (runif (J, -.1, .1))

par (mar=c(5,5,4,2)+.1)
plot (sample.size.jittered, coef(lm.unpooled), cex.lab=1.2, cex.axis=1.2,
      xlab="sample size in county j", ylab=expression (paste
                                                       ("est. intercept, ", alpha[j], "   (no pooling)")),
      pch=20, log="x", ylim=c(25, 30), yaxt="n", xaxt="n")
axis (1, quantile(ns), cex.axis=1.1)
axis (2, seq(25, 30), cex.axis=1.1)
for (j in 1:J){
  lines (rep(sample.size.jittered[j],2),
         coef(lm.unpooled)[j] + c(-1,1)*se.coef(lm.unpooled)[j], lwd=.5)
}
abline (coef(fit.cp)[1], 0, lwd=.5)
title(main="Estimates of County Means from the Fixed Effect Model")


#plot MLM estimates of county means + se's
par (mar=c(5,5,4,2)+.1)
a.hat.M1 <- coef(fit0)$cofips[,1]
a.se.M1 <- se.coef(fit0)$cofips

plot (as.numeric(ns), t(a.hat.M1), cex.lab=1.2, cex.axis=1.1,
      xlab="sample size in county j",
      ylab=expression (paste("est. intercept, ", alpha[j], "(multilevel model)")),
      pch=20, log="x", ylim=c(25, 30), yaxt="n", xaxt="n")
axis (1, quantile(ns), cex.axis=1.1)
axis (2, seq(25,30), cex.axis=1.1)
for (j in 1:length(unique(joindata$cofips))){
  lines (rep(as.numeric(ns)[j],2),
         as.vector(a.hat.M1[j]) + c(-1,1)*a.se.M1[j], lwd=.5, col="gray10")
}
abline (coef(fit.cp)[1], 0, lwd=.5)
title(main="Estimates of County Means from the MLM")


#plot MLM estimates of county means + se's, model with county covariates
par (mar=c(5,5,4,2)+.1)
a.hat.M2 <- coef(fit0.1)$cofips[,1]
a.se.M2 <- se.coef(fit0.1)$cofips

plot (as.numeric(ns), t(a.hat.M2), cex.lab=1.2, cex.axis=1.1,
      xlab="sample size in county j",
      ylab=expression (paste("est. intercept, ", alpha[j], "(multilevel model with covariates)")),
      pch=20, log="x", ylim=c(25, 30), yaxt="n", xaxt="n")
axis (1, quantile(ns), cex.axis=1.1)
axis (2, seq(25,30), cex.axis=1.1)
for (j in 1:length(unique(joindata$cofips))){
  lines (rep(as.numeric(ns)[j],2),
         as.vector(a.hat.M2[j]) + c(-1,1)*a.se.M2[j], lwd=.5, col="gray10")
}
abline (coef(fit.cp)[1], 0, lwd=.5)
title(main="Estimates of County Means from the MLM with county predictors")

#This plot shows that as the n_j goes down, the standard error of the estimate increases
qplot(y=se.coef(lm.unpooled), x=coef(lm.unpooled), size=sqrt(ns))

#again, we see the relationship between variance and n_j
qplot(y=as.numeric(a.se.M1),x=se.coef(lm.unpooled),color=sqrt(ns))

hist(se.coef(lm.unpooled), col="red")
hist(a.se.M1, add=T, col="white")
```


###Multilevel model with group-level predictor
Now, I fit the same model above, but this time I include a predictor at the county level, the poverty rate.

```{r}
#Now I estimate the multilevel model including the effects for the
#county level variables
fit.mix2<-lmer(bmiz~agez+lths+coll+black+hispanic+other+povz+(1|cofips), data=joindata)
display(fit.mix2, detail=T)
rand(fit.mix2)
ICC2<-VarCorr(fit.mix2)$cofips[1]/( VarCorr(fit.mix2)$cofips[1]+attr(VarCorr(fit.mix2), "sc"))
ICC2

#compare the random intercept ad multilevel model with a LRT
anova(fit.mix, fit.mix2)
#There is slight improvement, p=.0572 becuase the poverty variable was almost significant, t=1.90

```

The ICC goes down, which points to the fact that we are controlling away some of the between-county variance by including the county level predictor. 



###Random slope models

* We expand the random effect model to include group-varying slopes by:
$$
\begin{aligned}
\ E( Y) = \beta_{0j}+ \beta_{ j} x\\
\beta_{0j} = \beta_0 + u_{1j}\\
\beta_{j} = \beta + u_{2j}\\
\end{aligned}\\
\text{Where } \beta_0  \text{ is the average intercept, and } u_{1j } \text{ is }\\
\text{the group-specific deviation in the intercept}\\
\text{And where } \beta \text{ is the average slope, and } u_{2j } \text{ is}\\
\text{the group-specific deviation in the average slope}\\
$$

This effectively allows one or more of the individual level variables to have different effects in each of the groups. 

```{r}
#To do a random slope model, I do:
fit.mix3<-lmer(bmiz~agez+lths+coll+black+hispanic+other+povz+(black|cofips), joindata, REML=F)
display(fit.mix3, digits=3)
rand(fit.mix3)

#compare the models with a LRT
anova(fit.mix2, fit.mix3)
#the random slope model fits better

#plot random slopes and intercepts
rancoefs2<-ranef(fit.mix3)

plot(NULL, ylim=c(-.5, .5), xlim=c(-1,1),ylab="Intercept", xlab="Age")
title (main="Random Slope and Intercept Model")

for (i in 1: dim(rancoefs2$cofips)[1]){
  
  abline(a=fixef(fit.mix3)[1]+rancoefs2$cofips[[1]][i], b=fixef(fit.mix3)[2]+rancoefs2$cofips[[2]][i], col=2)
}
```


###Cross level interaction effect
Here, I show the model for a cross-level interaction. This model fits an interaction term between (at least) one individual level variable and a group level variable. 
This allows you to ask very informative questions regarding individuals within specific contexts.

```{r}
#Cross-level interaction model:
fit.mix4<-lmer(bmiz~agez+lths+coll+black+hispanic+other+black*povz+hispanic*povz+other*povz+(1|cofips), joindata, REML=F)
display(fit.mix4, digits=3)
#This basically says that racial/ethnic minorities in counties with higher than average poverty rates (povz==1 vs povz==0) have higher BMI's

rand(fit.mix4)

#compare the models with a LRT
anova(fit.mix3, fit.mix4)



```

